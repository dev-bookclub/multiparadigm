name: ë¦¬ë·°ì–´ ë“±ë¡
on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Repository Members and Assign Reviewers
        run: |
          set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          echo "===== ëª¨ë“  ë¦¬ë·°ì–´ í• ë‹¹ ì‘ì—… ì‹œì‘ ====="

          # PR ì‘ì„±ì ê°€ì ¸ì˜¤ê¸°
          author="${{ github.actor }}"
          echo "PR ì‘ì„±ì: $author"

          # ë ˆí¬ì§€í† ë¦¬ì˜ ë©¤ë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          members_response=$(curl -s -X GET \
            -H "Authorization: token ${{ secrets.REVIEWER_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/dev-bookclub/teams/multiparadigm/members")

          # API ì‘ë‹µì´ ìœ íš¨í•œ JSONì¸ì§€ í™•ì¸
          if ! echo "$members_response" | jq empty; then
            echo "âŒ GitHub API ì‘ë‹µì´ ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."
            echo "ì‘ë‹µ ë‚´ìš©: $members_response"
            exit 1
          fi

          # ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± (PR ì‘ì„±ìëŠ” ì œì™¸)
          reviewers=$(echo "$members_response" | jq -r --arg author "$author" '[.[].login | select(. != $author)]')
          echo "ë¦¬ë·°ì–´ ëª©ë¡: $reviewers"

          # ë¦¬ë·°ì–´ ëª©ë¡ì´ ë¹„ì–´ ìˆì„ ê²½ìš° ì²˜ë¦¬
          if [ -z "$reviewers" ] || [ "$reviewers" == "[]" ]; then
            echo "âš ï¸ PR ì‘ì„±ìë¥¼ ì œì™¸í•œ ë¦¬ë·°ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ë·°ì–´ë¥¼ í• ë‹¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 0
          fi

          # ë¦¬ë·°ì–´ ëª©ë¡ í™•ì¸
          echo "âœ… ìµœì¢… ì„ íƒëœ ë¦¬ë·°ì–´(JSON): $reviewers"

          # PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
          pr_number=${{ github.event.pull_request.number }}
          if [ -z "$pr_number" ]; then
            echo "âŒ PR ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ë·°ì–´ í• ë‹¹
          response=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.REVIEWER_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"reviewers\": $reviewers}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/requested_reviewers")

          # GitHub API ì‘ë‹µ ê²€ì‚¬
          if echo "$response" | grep -q '"errors"'; then
            echo "âŒ ë¦¬ë·°ì–´ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ."
            echo "ì˜¤ë¥˜ ë‚´ìš©: $response"
            exit 1
          fi

          echo "ğŸ‰ âœ… ëª¨ë“  ë¦¬ë·°ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "===== ëª¨ë“  ë¦¬ë·°ì–´ í• ë‹¹ ì‘ì—… ì¢…ë£Œ ====="
